import React, { useEffect, useRef, useState } from "react";

/*
  MOEBIUZ AI ‚Äî Single-file React component
  - Stylish, modern chat UI using Tailwind CSS
  - Developer: ¬© hamzx
  - Allows user to paste an OpenAI API key (stored in localStorage)
  - Supports selecting model and sending messages to OpenAI Chat Completions API
  - Notes: For production, proxy requests through your server to keep the API key secret.
*/

export default function MoebiuzAI() {
  const [apiKey, setApiKey] = useState(() => localStorage.getItem("moebiuz_api_key") || "");
  const [model, setModel] = useState(() => localStorage.getItem("moebiuz_model") || "gpt-4o-mini");
  const [messages, setMessages] = useState([
    { id: 1, role: "system", text: "Kamu adalah MOEBIUZ AI ‚Äî asisten cerdas, ramah, dan ringkas." },
  ]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [error, setError] = useState("");
  const bottomRef = useRef(null);

  useEffect(() => {
    localStorage.setItem("moebiuz_api_key", apiKey);
  }, [apiKey]);

  useEffect(() => {
    localStorage.setItem("moebiuz_model", model);
  }, [model]);

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages, loading]);

  function addMessage(role, text) {
    setMessages((m) => [...m, { id: Date.now(), role, text }]);
  }

  async function sendMessage(e) {
    e?.preventDefault();
    setError("");
    if (!input.trim()) return;
    const userText = input.trim();
    addMessage("user", userText);
    setInput("");

    // Guardrails
    if (!apiKey) {
      setError("Masukkan OpenAI API Key di pengaturan (‚öôÔ∏è). Untuk keamanan, pertimbangkan proxy server.");
      return;
    }

    setLoading(true);
    try {
      // Prepare body for Chat Completions v1
      const body = {
        model: model,
        messages: messages
          .filter((m) => m.role !== "system" || m.role === "system")
          .concat([{ role: "user", content: userText }])
          .map((m) => (m.role === "system" ? { role: "system", content: m.text } : { role: m.role, content: m.text })),
        max_tokens: 700,
        temperature: 0.7,
      };

      const resp = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify(body),
      });

      if (!resp.ok) {
        const errText = await resp.text();
        throw new Error(`OpenAI API error ${resp.status}: ${errText}`);
      }

      const data = await resp.json();
      const assistantText = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "Maaf, tidak ada balasan.";
      addMessage("assistant", assistantText);
    } catch (err) {
      console.error(err);
      setError(err.message || String(err));
    } finally {
      setLoading(false);
    }
  }

  function clearChat() {
    setMessages([{ id: 1, role: "system", text: "Kamu adalah MOEBIUZ AI ‚Äî asisten cerdas, ramah, dan ringkas." }]);
  }

  function exportChat() {
    const blob = new Blob([JSON.stringify(messages, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `moebiuz_chat_${new Date().toISOString()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-violet-900 to-indigo-800 text-slate-100 flex items-stretch p-6">
      <div className="mx-auto w-full max-w-4xl rounded-2xl bg-white/5 backdrop-blur-sm shadow-2xl ring-1 ring-white/10 overflow-hidden flex flex-col">
        {/* Header */}
        <header className="flex items-center justify-between p-4 border-b border-white/6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-lg bg-gradient-to-tr from-pink-500 to-yellow-400 flex items-center justify-center text-black font-extrabold text-lg">MZ</div>
            <div>
              <h1 className="text-lg font-bold tracking-tight">MOEBIUZ AI</h1>
              <p className="text-sm text-white/70">Developer ¬© hamzx ‚Äî Chat like Cici AI, but yours.</p>
            </div>
          </div>

          <div className="flex items-center gap-3">
            <button onClick={() => setShowSettings((s) => !s)} className="px-3 py-2 rounded-md bg-white/6 hover:bg-white/8">‚öôÔ∏è Settings</button>
            <button onClick={clearChat} className="px-3 py-2 rounded-md bg-white/6 hover:bg-white/8">üßπ Clear</button>
            <button onClick={exportChat} className="px-3 py-2 rounded-md bg-white/6 hover:bg-white/8">‚¨áÔ∏è Export</button>
          </div>
        </header>

        <main className="flex-1 overflow-hidden flex gap-6 p-6">
          {/* Sidebar - quick prompts */}
          <aside className="w-60 hidden md:block">
            <div className="rounded-lg bg-white/4 p-4 h-full flex flex-col gap-3">
              <h3 className="font-semibold">Quick Prompts</h3>
              <button onClick={() => { setInput('Buatkan ringkasan 5 poin dari materi di bawah...'); }} className="text-left p-3 rounded-md bg-white/3">Ringkasan singkat</button>
              <button onClick={() => { setInput('Buatkan rencana belajar selama 7 hari untuk topik X...'); }} className="text-left p-3 rounded-md bg-white/3">Rencana belajar</button>
              <button onClick={() => { setInput('Tolong perbaiki dan ringkas email ini: ...'); }} className="text-left p-3 rounded-md bg-white/3">Perbaikan email</button>
              <div className="mt-auto text-xs text-white/60">Tip: simpan API key di Settings. Untuk keamanan, gunakan server proxy di produksi.</div>
            </div>
          </aside>

          {/* Chat area */}
          <section className="flex-1 flex flex-col bg-gradient-to-b from-white/3 to-white/2 rounded-xl p-4">
            <div className="flex-1 overflow-auto pr-2">
              {messages.map((m) => (
                <div key={m.id} className={`mb-4 flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`${m.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white/8 text-white'} max-w-[75%] p-3 rounded-xl shadow-sm` }>
                    <div className="text-xs text-white/70 mb-1">{m.role === 'user' ? 'You' : m.role === 'system' ? 'System' : 'MOEBIUZ'}</div>
                    <div className="whitespace-pre-wrap">{m.text}</div>
                  </div>
                </div>
              ))}
              <div ref={bottomRef} />
            </div>

            <form onSubmit={sendMessage} className="mt-4">
              {error && <div className="mb-2 text-sm text-red-300">‚ö†Ô∏è {error}</div>}
              <div className="flex gap-3">
                <textarea
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  placeholder="Tulis pesan... (contoh: Jelaskan bedanya HTTP dan HTTPS)"
                  className="flex-1 min-h-[56px] max-h-36 rounded-lg p-3 bg-white/6 placeholder:text-white/50 resize-y"
                />
                <div className="flex flex-col gap-2">
                  <button type="submit" disabled={loading} className="px-4 py-3 rounded-lg bg-gradient-to-tr from-pink-500 to-yellow-400 font-semibold">{loading ? 'Mengirim...' : 'Kirim'}</button>
                  <button type="button" onClick={() => setInput('')} className="px-4 py-2 rounded-lg bg-white/6">Clear</button>
                </div>
              </div>
              <div className="mt-2 text-xs text-white/60 flex items-center justify-between">
                <div>Model: 
                  <select value={model} onChange={(e) => setModel(e.target.value)} className="ml-2 bg-transparent">
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="gpt-4o-realtime-preview">gpt-4o-realtime-preview</option>
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                  </select>
                </div>
                <div>Developer ¬© hamzx</div>
              </div>
            </form>
          </section>
        </main>

        {/* Settings panel */}
        {showSettings && (
          <div className="p-4 border-t border-white/6 bg-white/3">
            <div className="max-w-4xl mx-auto flex flex-col md:flex-row gap-6">
              <div className="flex-1">
                <h3 className="font-semibold mb-2">Pengaturan API</h3>
                <p className="text-sm text-white/70 mb-2">Tempelkan OpenAI API Key Anda di bawah. (Disimpan di browser melalui localStorage.)</p>
                <input
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="sk-..."
                  className="w-full p-3 rounded-md bg-white/6"
                />
                <div className="mt-2 text-xs text-white/60">Keamanan: Menyimpan API key di browser berisiko. Untuk penggunaan publik, buat server proxy untuk menyembunyikan kunci.</div>
              </div>

              <div className="w-64">
                <h3 className="font-semibold mb-2">Aksi</h3>
                <button onClick={() => { localStorage.removeItem('moebiuz_api_key'); setApiKey(''); }} className="w-full p-3 rounded-md bg-white/6 mb-2">Hapus API Key</button>
                <button onClick={() => { navigator.clipboard?.writeText(JSON.stringify(messages, null, 2)); }} className="w-full p-3 rounded-md bg-white/6 mb-2">Salin Chat (JSON)</button>
                <button onClick={() => { alert('TODO: Hubungkan tema, avatar, integrasi tambahan.'); }} className="w-full p-3 rounded-md bg-white/6">Kustomisasi UI</button>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Floating credits */}
      <div className="fixed right-6 bottom-6 text-white/60 text-sm">MOEBIUZ AI ‚Ä¢ Developer ¬© hamzx</div>
    </div>
  );
}
